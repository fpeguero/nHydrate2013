//------------------------------------------------------------------------------
// <auto-generated>
//    This code was generated from a template.
//
//    Creador : Administrator
//    Dominio : OSISPC
//    Pc      : OSISPC
//    Fecha   : 5/17/2014 6:34:22 AM
//
//    Manual changes to this file may cause unexpected behavior in your application.
//    Manual changes to this file will be overwritten if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using CodeFluent.Runtime;
using OSIS.PEPPAM.Mvc.Extensions.Controllers;
using OSIS.PEPPAM.Mvc.Models;
using OSIS.PEPPAM.Mvc.Models.Shared;
using OSIS.PEPPAM.Mvc.UI;

namespace OSIS.PEPPAM.Mvc.Controllers
{
	public partial class Sistemas_Slides_MasterController : Sistemas_Slides_MasterControllerBase
	{






        [HttpPost]
        public override ActionResult Load(GridRequestViewModel gridRequest)
        {
            OrderByArgumentCollection orderByArguments = new OrderByArgumentCollection();
            orderByArguments.Add("[" + gridRequest.SortColumnName + "]", gridRequest.SortDirection);

            PageOptions pageOptions = new PageOptions();
            pageOptions.OrderByArguments = orderByArguments;

            var totalCount = 0;

            var allsistemasSlidesMaster = Sistemas_Slides_MasterModel.PageLoadAllPaging(1 + gridRequest.RowStartIndex / gridRequest.RowCount,
                gridRequest.RowCount, gridRequest.Search, pageOptions, out totalCount);

            var displayRecords = allsistemasSlidesMaster.Count;
            var totalRecords = totalCount;

            var dateFormat = System.Globalization.CultureInfo.CurrentCulture.TwoLetterISOLanguageName == "en"
                ? "MM/dd/yyyy"
                : "dd/MM/yyyy";
            System.Globalization.DateTimeFormatInfo dtfi =
                System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat;
            dtfi.DateSeparator = "/";

            return Json(new
            {
                iTotalDisplayRecords = displayRecords,
                iTotalRecords = totalRecords,
                sEcho = gridRequest.GridCustomData,
                aaData =
                    allsistemasSlidesMaster.Select(
                        d =>
                            new
                            {
                                d.Slide_Secuencia,
                                d.Slide_Image,
                                d.Slide_Contenido,
                                Slide_Vigencia_Desde = d.Slide_Vigencia_Desde.ToString(dateFormat, dtfi),
                                Slide_Vigencia_Hasta = d.Slide_Vigencia_Hasta.ToString(dateFormat, dtfi),
                                d.Slide_Fijo,
                                d.Slide_Image_Abajo,
                                d.Slide_Css,
                                d.Slide_Image_Publicar,
                                d.Registro_Estado,
                                Registro_Fecha = d.Registro_Fecha.ToString(dateFormat, dtfi),
                                d.Registro_Usuario
                            })
            });

        }



        #region Create


        // ******************************************* 
        // URL: /Sistemas_Slides_Master/Create 
        // ******************************************* 

        public override ActionResult Create()
        {
            var sistemasSlidesMaster = new Sistemas_Slides_MasterModel();
            sistemasSlidesMaster.IsNew = true;
            sistemasSlidesMaster.Registro_Estado = "A";
            sistemasSlidesMaster.Slide_Image = "N/E";
            sistemasSlidesMaster.Slide_Image_Abajo = "N/E";
            sistemasSlidesMaster.Slide_Image_Publicar = "N";

            sistemasSlidesMaster.Slide_Css = "N/E";
            

            return View(sistemasSlidesMaster);
        }

        //
        // POST: /Usuarios/Create
        [HttpPost]
        [ValidateInput(false)]
        public ActionResult CreateOrEdit(Sistemas_Slides_MasterModel sistemasSlidesMaster, HttpPostedFileBase file, HttpPostedFileBase file2)
        {
            if (sistemasSlidesMaster.IsNew && (file == null || file.ContentLength <= 0))
            {
                ModelState.AddModelError("",Messages.GetOrSetMensaje("ERROR_DEBE_SUBIR_IMAGEN_SLIDES"));
            }

            if (ModelState.IsValid)
            {


                if (file != null && file.ContentLength > 0)
                {
                    string fileExtension =
                        System.IO.Path.GetExtension(file.FileName);
                    var newName = Guid.NewGuid().ToString();
                    string fileLocation = Server.MapPath("~/UploadFiles/Slides/") + newName + fileExtension;
                    file.SaveAs(fileLocation);

                    sistemasSlidesMaster.Slide_Image = newName + fileExtension;
                }

                if (file2 != null && file2.ContentLength > 0)
                {
                    string fileExtension =
                        System.IO.Path.GetExtension(file2.FileName);
                    var newName = Guid.NewGuid().ToString();
                    string fileLocation = Server.MapPath("~/UploadFiles/Slides/") + newName + fileExtension;
                    file2.SaveAs(fileLocation);

                    sistemasSlidesMaster.Slide_Image_Abajo = newName + fileExtension;
                }
                

                //Campos Auditorias
                sistemasSlidesMaster.Registro_Fecha = DateTime.Now;
                sistemasSlidesMaster.Registro_Usuario = User.Identity.Name;
                

                var result = sistemasSlidesMaster.Save();

                ShowMessages(MessagesType.Success, Messages.GetOrSetMensaje("MENSAJE_SLIDER_AGREGADO"));

                if (result)
                {
                    return RedirectToAction("Index");
                }

            }

            if (sistemasSlidesMaster.IsNew)
            {
                return View("Create", sistemasSlidesMaster);
            }
            else
            {
                return View("Edit", sistemasSlidesMaster);
            }
        }



        #endregion

        #region Edit


        // ******************************************* 
        // URL: /Sistemas_Slides_Master/Edit/id 
        // ******************************************* 

        public override ActionResult Edit(int slide_Secuencia)
        {

            var sistemasSlidesMaster = Sistemas_Slides_MasterModel.LoadByEntityKey(slide_Secuencia.ToString());

            sistemasSlidesMaster.IsNew = false;
            //sistemasSlidesMaster.Slide_Image = "N/A";

            return View(sistemasSlidesMaster);
        }

        [HttpPost]
        [ValidateInput(false)]
        public override ActionResult Edit(Sistemas_Slides_MasterModel sistemasSlidesMaster)
        {

            if (ModelState.IsValid)
            {
                //Campos Auditorias
                sistemasSlidesMaster.Registro_Fecha = DateTime.Now;
                sistemasSlidesMaster.Registro_Usuario = User.Identity.Name;


                var result = sistemasSlidesMaster.Save();

                if (result)
                {
                    return RedirectToAction("Index");
                }
            }

            ViewBag.IsNew = false;
            return View(sistemasSlidesMaster);
        }


        [HttpPost]
        public override ActionResult Delete(string slide_Secuencia)
        {
            try
            {
                var _deleteModel = Sistemas_Slides_MasterModel.LoadByEntityKey(slide_Secuencia);
                _deleteModel.Delete();
            }
            catch (Exception ex)
            {
                Response.StatusCode = 500;
                return Content(ex.Message);
            }
            return Content(string.Empty);
        }



        #endregion
	}
}

